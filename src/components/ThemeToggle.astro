---
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
---

<Button
  id="theme-toggle"
  variant="ghost"
  size="icon"
  title="Toggle theme"
  className="-my-2 -me-2 size-8"
>
  <Icon name="lucide:sun" class="size-4 dark:hidden" />
  <Icon name="lucide:moon" class="absolute hidden size-4 dark:block" />
  <span class="sr-only">Toggle theme</span>
</Button>

<script is:inline data-astro-rerun>
  (() => {
    const theme = (() => {
      const stored = localStorage?.getItem('theme') ?? ''
      if (['dark', 'light'].includes(stored)) return stored
      return window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light'
    })()

    document.documentElement.setAttribute('data-theme', theme)
    window.localStorage.setItem('theme', theme)
  })()
</script>

<script>
  // --- UPDATED FUNCTION ---
  /**
   * Updates the 'theme-color' meta tag.
   * This uses a "remove and re-add" hack to try and force
   * Safari iOS to recognize the change.
   */
  function updateThemeColorMeta() {
    // Get the *actual* computed color, which respects your CSS variables
    const computedColor = getComputedStyle(document.documentElement).backgroundColor

    if (!computedColor) return // Safety check

    const oldMetaTag = document.getElementById('theme-color-meta')

    // If the tag exists, remove it
    if (oldMetaTag) {
      oldMetaTag.remove()
    }

    // Create a new meta tag with the same ID and new color
    const newMetaTag = document.createElement('meta')
    newMetaTag.id = 'theme-color-meta'
    newMetaTag.name = 'theme-color'
    newMetaTag.setAttribute('content', computedColor)
    document.head.appendChild(newMetaTag)
  }

  function handleToggleClick() {
    const element = document.documentElement
    const currentTheme = element.getAttribute('data-theme')
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark'

    element.classList.add('[&_*]:transition-none')
    element.setAttribute('data-theme', newTheme)

    // Force a style reflow
    window.getComputedStyle(element).getPropertyValue('opacity')

    // --- UPDATED ---
    // This will now run the "remove and re-add" hack
    updateThemeColorMeta()

    requestAnimationFrame(() => {
      element.classList.remove('[&_*]:transition-none')
    })

    localStorage.setItem('theme', newTheme)
  }

  function initThemeToggle() {
    document
      .getElementById('theme-toggle')
      ?.addEventListener('click', handleToggleClick)
  }

  // Set up the click listener
  initThemeToggle()

  // --- UPDATED ---
  // Run on initial page load (after inline script)
  // to ensure the color is from computed CSS, not hard-coded.
  document.addEventListener('DOMContentLoaded', () => {
    // We use a small delay to ensure CSS has been fully parsed.
    setTimeout(updateThemeColorMeta, 100)
  })

  // Handle theme updates after Astro's page swaps
  document.addEventListener('astro:after-swap', () => {
    const storedTheme = localStorage.getItem('theme') || 'light'
    const element = document.documentElement

    element.classList.add('[&_*]:transition-none')
    element.setAttribute('data-theme', storedTheme)
    
    // Force reflow
    window.getComputedStyle(element).getPropertyValue('opacity')

    // --- UPDATED ---
    // Update the meta tag for the new page
    updateThemeColorMeta()

    requestAnimationFrame(() => {
      element.classList.remove('[&_*]:transition-none')
    })

    // Re-attach the click listener
    initThemeToggle()
  })
</script>